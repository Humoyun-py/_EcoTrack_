{% extends "base.html" %}

{% block title %}EcoVerse - Eco Hero{% endblock %}

{% block content %}
<div class="container mt-4 dashboard-content">
    <!-- Welcome Animation Container -->
    <div id="welcomeAnimation" class="welcome-container">
        <div class="nature-background" id="natureBg"></div>
        <div class="welcome-content">
            <div class="welcome-icon">üåç</div>
            <h1 class="welcome-title">EcoVerse ga Xush Kelibsiz!</h1>
            <p class="welcome-subtitle">Tabiatni himoya qilish sarguzashti boshlanmoqda</p>
            <div class="welcome-user">{{ user.username }}</div>
        </div>
    </div>

    <!-- Yangiliklar va E'lonlar -->
    <div class="row mb-4">
        <!-- Yangiliklar -->
        <div class="col-md-8">
            <div class="card eco-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-newspaper me-2"></i>üì∞ So'nggi Yangiliklar</h5>
                </div>
                <div class="card-body">
                    <div id="newsCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% if news_list %}
                            {% for news in news_list[:3] %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <h6>{{ news.title }}</h6>
                                <p class="text-muted">{{ news.content[:100] }}{% if news.content|length > 100 %}...{% endif %}</p>
                                <small class="text-muted">{{ news.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="carousel-item active">
                                <h6>Yangiliklar yo'q</h6>
                                <p class="text-muted">Hozircha yangiliklar mavjud emas</p>
                            </div>
                            {% endif %}
                        </div>
                        {% if news_list|length > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#newsCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Oldingi</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#newsCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Keyingi</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- E'lonlar -->
        <div class="col-md-4">
            <div class="card eco-card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>üì¢ E'lonlar</h5>
                </div>
                <div class="card-body">
                    <div id="announcements-container">
                        {% if announcements %}
                        {% for announcement in announcements %}
                        <div class="announcement-item mb-3 p-3 border rounded {% if announcement.announcement_type == 'warning' %}border-warning{% elif announcement.announcement_type == 'success' %}border-success{% else %}border-info{% endif %}">
                            <h6 class="mb-2">{{ announcement.title }}</h6>
                            <p class="text-muted mb-2 small">{{ announcement.content[:80] }}{% if announcement.content|length > 80 %}...{% endif %}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    {{ announcement.start_date.strftime('%d.%m.%Y') }} - {{ announcement.end_date.strftime('%d.%m.%Y') }}
                                </small>
                                <span class="badge bg-{% if announcement.announcement_type == 'warning' %}warning text-dark{% elif announcement.announcement_type == 'success' %}success{% else %}info{% endif %}">
                                    {{ announcement.announcement_type }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-bullhorn fa-2x mb-2"></i>
                            <p>Hozircha e'lonlar mavjud emas</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asosiy Dashboard Content -->
    <div class="row mb-4">
        <!-- Hero Profile Card -->
        <div class="col-md-4 mb-4">
            <div class="card eco-card hero-profile-card">
                <div class="card-body text-center">
                    <div class="hero-avatar mb-3 floating-element">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <h4 class="hero-name">{{ user.username }}</h4>
                    <p class="text-muted">Eco Hero</p>
                    <div class="level-badge mb-3">
                        <span class="badge badge-eco">Level {{ user.level }}</span>
                    </div>
                    <a href="{{ url_for('hero') }}" class="btn btn-eco-animated w-100">
                        <i class="fas fa-user-edit me-2"></i>Hero ni tahrirlash
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Card -->
        <div class="col-md-4 mb-4">
            <div class="card eco-card stats-card">
                <div class="card-body text-center">
                    <h5 class="card-title mb-4">üìä Statistika</h5>
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-item">
                                <div class="stat-icon">üí∞</div>
                                <h4 id="userCoins" class="stat-value">{{ user.coins }}</h4>
                                <small class="stat-label">Coinlar</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <div class="stat-icon">‚ö°</div>
                                <h4 id="userEnergy" class="stat-value">{{ user.energy }}</h4>
                                <small class="stat-label">Energiya</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <div class="stat-icon">üî•</div>
                                <h4 id="userStreak" class="stat-value">{{ user.streak }}</h4>
                                <small class="stat-label">Kun</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="col-md-4 mb-4">
            <div class="card eco-card quick-actions-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">üöÄ Tezkor Harakatlar</h5>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('ml_quiz') }}" class="btn btn-eco-animated">
                            <i class="fas fa-brain me-2"></i>Testni Boshlash
                        </a>
                        <a href="{{ url_for('games') }}" class="btn btn-outline-eco">
                            <i class="fas fa-gamepad me-2"></i>O'yinlar
                        </a>
                        <a href="{{ url_for('shop') }}" class="btn btn-outline-eco">
                            <i class="fas fa-store me-2"></i>Do'kon
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topshiriqlar Bo'limi -->
    <div class="row">
        <div class="col-12">
            <div class="card eco-card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>üéØ Topshiriqlar</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2" id="completed-tasks">Bajarilgan: {{ completed_task_ids|length }}/{{ all_tasks|length }}</span>
                        <button class="btn btn-sm btn-light" onclick="refreshTasks()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Kunlik topshiriqlar -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-calendar-day me-2"></i>Kunlik Topshiriqlar
                            <span class="badge bg-primary ms-2" id="daily-tasks-badge">Yangi!</span>
                        </h6>
                        {% if todays_tasks and todays_tasks.daily_tasks %}
                            {% for task in todays_tasks.daily_tasks %}
                            <div class="card task-card mb-3 eco-card {% if task.id in completed_task_ids %}completed-task{% endif %}">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="d-flex align-items-center">
                                                {% if task.id in completed_task_ids %}
                                                <span class="badge bg-success me-2"><i class="fas fa-check"></i></span>
                                                {% endif %}
                                                <h6 class="task-title mb-0">{{ task.title }}</h6>
                                                <span class="badge bg-info ms-2">Kunlik</span>
                                            </div>
                                            <p class="task-description text-muted mt-2">{{ task.description }}</p>
                                            <div class="task-meta">
                                                <span class="badge bg-{% if task.difficulty == 'easy' %}success{% elif task.difficulty == 'medium' %}warning{% else %}danger{% endif %} me-2">
                                                    {{ task.difficulty }}
                                                </span>
                                                <span class="me-3">üí∞ {{ task.reward_coins }} coin</span>
                                                <span>‚ö° {{ task.energy_cost }} energiya</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            {% if task.id in completed_task_ids %}
                                            <button class="btn btn-success btn-eco-animated" disabled>
                                                <i class="fas fa-check me-2"></i>Bajarildi
                                            </button>
                                            {% else %}
                                            {% if task.quiz_required %}
                                            <a href="{{ url_for('start_task_quiz', task_id=task.id) }}" class="btn btn-primary btn-eco-animated {% if user.energy < task.energy_cost %}disabled{% endif %}" {% if user.energy < task.energy_cost %}title="Energiya yetarli emas" {% endif %}>
                                                Testni Boshlash
                                            </a>
                                            {% else %}
                                            <button class="btn btn-success btn-eco-animated complete-task" 
                                                    data-task-id="{{ task.id }}" 
                                                    data-task-title="{{ task.title }}"
                                                    data-energy-cost="{{ task.energy_cost }}"
                                                    data-reward-coins="{{ task.reward_coins }}"
                                                    {% if user.energy < task.energy_cost %}disabled{% endif %}>
                                                Bajarish
                                            </button>
                                            {% endif %}
                                            {% endif %}

                                            {% if user.energy < task.energy_cost and task.id not in completed_task_ids %}
                                            <small class="text-danger mt-2 d-block">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                Energiya yetarli emas
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Bugun kunlik topshiriqlar mavjud emas
                            </div>
                        {% endif %}
                    </div>

                    <!-- Doimiy topshiriqlar -->
                    <div class="mb-4">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-infinity me-2"></i>Doimiy Topshiriqlar
                        </h6>
                        {% for task in regular_tasks %}
                        <div class="card task-card mb-3 eco-card {% if task.id in completed_task_ids %}completed-task{% endif %}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center">
                                            {% if task.id in completed_task_ids %}
                                            <span class="badge bg-success me-2"><i class="fas fa-check"></i></span>
                                            {% endif %}
                                            <h6 class="task-title mb-0">{{ task.title }}</h6>
                                        </div>
                                        <p class="task-description text-muted mt-2">{{ task.description }}</p>
                                        <div class="task-meta">
                                            <span class="badge bg-{% if task.difficulty == 'easy' %}success{% elif task.difficulty == 'medium' %}warning{% else %}danger{% endif %} me-2">
                                                {{ task.difficulty }}
                                            </span>
                                            <span class="me-3">üí∞ {{ task.reward_coins }} coin</span>
                                            <span>‚ö° {{ task.energy_cost }} energiya</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if task.id in completed_task_ids %}
                                        <button class="btn btn-success btn-eco-animated" disabled>
                                            <i class="fas fa-check me-2"></i>Bajarildi
                                        </button>
                                        {% else %}
                                        {% if task.quiz_required %}
                                        <a href="{{ url_for('start_task_quiz', task_id=task.id) }}" class="btn btn-primary btn-eco-animated {% if user.energy < task.energy_cost %}disabled{% endif %}" {% if user.energy < task.energy_cost %}title="Energiya yetarli emas" {% endif %}>
                                            Testni Boshlash
                                        </a>
                                        {% else %}
                                        <button class="btn btn-success btn-eco-animated complete-task" 
                                                data-task-id="{{ task.id }}" 
                                                data-task-title="{{ task.title }}"
                                                data-energy-cost="{{ task.energy_cost }}"
                                                data-reward-coins="{{ task.reward_coins }}"
                                                {% if user.energy < task.energy_cost %}disabled{% endif %}>
                                            Bajarish
                                        </button>
                                        {% endif %}
                                        {% endif %}

                                        {% if user.energy < task.energy_cost and task.id not in completed_task_ids %}
                                        <small class="text-danger mt-2 d-block">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Energiya yetarli emas
                                        </small>
                                        {% endif %}

                                        {% if task.quiz_required and task.id not in completed_task_ids %}
                                        <small class="text-info mt-2 d-block">
                                            <i class="fas fa-graduation-cap me-1"></i>
                                            Test talab qilinadi
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Doimiy topshiriqlar mavjud emas
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Test topshiriqlari -->
                    <div>
                        <h6 class="text-info mb-3">
                            <i class="fas fa-graduation-cap me-2"></i>Test Topshiriqlari
                        </h6>

                        <!-- Eco Bilim Testi -->
                        <div class="card task-card mb-3 eco-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="task-title">üß† Eco Bilim Testi</h6>
                                        <p class="task-description text-muted">
                                            Ekologiya bilimingizni sinab ko'ring va 50 coin yuting
                                        </p>
                                        <div class="task-meta">
                                            <span class="badge bg-danger me-2">O'ta</span>
                                            <span class="me-3">üí∞ 50 coin</span>
                                            <span>‚ö° 20 energiya</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <a href="{{ url_for('ml_quiz') }}" class="btn btn-eco-animated {% if user.energy < 20 %}disabled{% endif %}" {% if user.energy < 20 %}title="Energiya yetarli emas" {% endif %}>
                                            Testni Boshlash
                                        </a>
                                        {% if user.energy < 20 %}
                                        <small class="text-danger mt-2 d-block">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Energiya yetarli emas
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% for task in quiz_tasks %}
                        <div class="card task-card mb-3 eco-card {% if task.id in completed_task_ids %}completed-task{% endif %}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center">
                                            {% if task.id in completed_task_ids %}
                                            <span class="badge bg-success me-2"><i class="fas fa-check"></i></span>
                                            {% endif %}
                                            <h6 class="task-title mb-0">{{ task.title }}</h6>
                                            <span class="badge bg-info ms-2">Test</span>
                                        </div>
                                        <p class="task-description text-muted mt-2">{{ task.description }}</p>
                                        <div class="task-meta">
                                            <span class="badge bg-{% if task.difficulty == 'easy' %}success{% elif task.difficulty == 'medium' %}warning{% else %}danger{% endif %} me-2">
                                                {{ task.difficulty }}
                                            </span>
                                            <span class="me-3">üí∞ {{ task.reward_coins }} coin</span>
                                            <span>‚ö° {{ task.energy_cost }} energiya</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if task.id in completed_task_ids %}
                                        <button class="btn btn-success btn-eco-animated" disabled>
                                            <i class="fas fa-check me-2"></i>Bajarildi
                                        </button>
                                        {% else %}
                                        <a href="{{ url_for('start_task_quiz', task_id=task.id) }}" class="btn btn-primary btn-eco-animated {% if user.energy < task.energy_cost %}disabled{% endif %}" {% if user.energy < task.energy_cost %}title="Energiya yetarli emas" {% endif %}>
                                            Testni Boshlash
                                        </a>
                                        {% endif %}

                                        {% if user.energy < task.energy_cost and task.id not in completed_task_ids %}
                                        <small class="text-danger mt-2 d-block">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Energiya yetarli emas
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Test topshiriqlari mavjud emas
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Do'kon va Energiya Bo'limi -->
    <div class="row mt-4">
        <!-- Do'kon -->
        <div class="col-md-8">
            <div class="card eco-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-store me-2"></i>üõçÔ∏è Do'kon</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for item in items %}
                        <div class="col-md-4 mb-3">
                            <div class="card shop-item eco-card">
                                <div class="card-body text-center">
                                    <div class="item-icon mb-2">
                                        <i class="fas fa-tshirt fa-2x text-success"></i>
                                    </div>
                                    <h6 class="item-name">{{ item.name }}</h6>
                                    <p class="item-price text-warning fw-bold">üí∞ {{ item.price }} coin</p>
                                    <button class="btn btn-sm btn-eco buy-item" 
                                            data-item-id="{{ item.id }}" 
                                            data-item-price="{{ item.price }}" 
                                            data-item-name="{{ item.name }}" 
                                            {% if user.coins < item.price %}disabled{% endif %}>
                                        Sotib olish
                                    </button>
                                    {% if user.coins < item.price %}
                                    <small class="text-danger d-block mt-1">
                                        Coin yetarli emas
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Energiya Paketlari -->
        <div class="col-md-4">
            <div class="card eco-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>‚ö° Energiya</h5>
                </div>
                <div class="card-body">
                    {% for pack in energy_packs %}
                    <div class="energy-pack-card mb-3 p-3 border rounded">
                        <h6>{{ pack.name }}</h6>
                        <p class="text-muted mb-1">{{ pack.description }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-success">+{{ pack.energy_amount }} ‚ö°</span>
                            <span class="text-warning">üí∞ {{ pack.price }}</span>
                            <button class="btn btn-sm btn-success buy-energy" 
                                    data-pack-id="{{ pack.id }}"
                                    data-energy="{{ pack.energy_amount }}" 
                                    data-price="{{ pack.price }}"
                                    data-pack-name="{{ pack.name }}"
                                    {% if user.coins < pack.price %}disabled{% endif %}>
                                Sotib olish
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .announcement-item {
        background: linear-gradient(135deg, #fff3cd, #fff);
        border-left: 4px solid #ffc107 !important;
    }

    .announcement-item.border-success {
        background: linear-gradient(135deg, #d1edff, #fff);
        border-left-color: #198754 !important;
    }

    .announcement-item.border-info {
        background: linear-gradient(135deg, #d1ecf1, #fff);
        border-left-color: #0dcaf0 !important;
    }

    .completed-task {
        opacity: 0.7;
        background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        border-left: 4px solid #28a745 !important;
    }

    .completed-task .task-title {
        text-decoration: line-through;
        color: #6c757d;
    }

    #daily-tasks-badge {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .carousel-item {
        padding: 10px;
    }

    .welcome-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 50%, #4CAF50 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        animation: welcomeFloat 2s ease-out forwards;
    }

    .eco-card {
        background: linear-gradient(135deg, #FFFFFF 0%, #F1F8E9 100%);
        border: none;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(27, 94, 32, 0.1);
        transition: all 0.4s ease;
    }

    .btn-eco-animated {
        background: linear-gradient(135deg, #1B5E20, #2E7D32);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 25px;
        font-weight: 600;
        transition: all 0.4s ease;
    }

    @keyframes welcomeFloat {
        0% { transform: scale(1.1); opacity: 0; }
        50% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }

    .floating-element {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }

    .hero-avatar {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #1B5E20, #2E7D32);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin: 0 auto;
    }

    .stat-item {
        text-align: center;
    }

    .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 5px 0;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .task-card {
        transition: all 0.3s ease;
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(27, 94, 32, 0.2);
    }

    .shop-item {
        transition: all 0.3s ease;
    }

    .shop-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
    }

    .energy-pack-card {
        transition: all 0.3s ease;
    }

    .energy-pack-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
    }
</style>

<script>
    // Welcome animatsiyani o'chirish
    setTimeout(() => {
        const welcomeContainer = document.getElementById('welcomeAnimation');
        if (welcomeContainer) {
            welcomeContainer.style.display = 'none';
        }
    }, 2000);

    // Foydalanuvchi statistikasini yangilash funksiyasi
    function updateUserStats(data) {
        console.log('Updating user stats:', data);
        if (data.coins !== undefined) {
            const coinsElement = document.getElementById('userCoins');
            if (coinsElement) coinsElement.textContent = data.coins;
        }
        if (data.energy !== undefined) {
            const energyElement = document.getElementById('userEnergy');
            if (energyElement) energyElement.textContent = data.energy;
        }
        if (data.streak !== undefined) {
            const streakElement = document.getElementById('userStreak');
            if (streakElement) streakElement.textContent = data.streak;
        }
    }

    // Topshiriqni bajarish funksiyasi
    function completeTask(taskId, taskTitle, energyCost, rewardCoins) {
        if (confirm(`"${taskTitle}" topshirig'ini bajarishni xohlaysizmi?\nEnergiya sarfi: ${energyCost}\nMukofot: ${rewardCoins} coin`)) {
            fetch(`/complete_task/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Statistikani yangilash
                    updateUserStats({
                        coins: data.new_coins,
                        energy: data.new_energy
                    });

                    // Tugmani o'zgartirish
                    const buttons = document.querySelectorAll(`[data-task-id="${taskId}"]`);
                    buttons.forEach(button => {
                        button.disabled = true;
                        button.textContent = '‚úÖ Bajarildi';
                        button.classList.remove('btn-primary', 'btn-success');
                        button.classList.add('btn-success');
                    });

                    // Kartani yangilash
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        taskCard.classList.add('completed-task');
                    }

                    // Bajarilgan topshiriqlar sonini yangilash
                    updateCompletedTasksCount();
                } else {
                    alert('Xatolik: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Xatolik:', error);
                alert('Server xatosi!');
            });
        }
    }

    // Mahsulot sotib olish
    function buyItem(itemId, itemName, itemPrice) {
        if (confirm(`"${itemName}" ni ${itemPrice} coin ga sotib olishni xohlaysizmi?`)) {
            fetch('/buy_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    item_id: itemId,
                    price: itemPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    updateUserStats({ coins: data.new_coins });
                    
                    // Tugmani o'zgartirish
                    const button = document.querySelector(`.buy-item[data-item-id="${itemId}"]`);
                    if (button) {
                        button.disabled = true;
                        button.textContent = 'Sotib olindi';
                    }
                } else {
                    alert('Xatolik: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Xatolik:', error);
                alert('Server xatosi!');
            });
        }
    }

    // Energiya paketi sotib olish
    function buyEnergyPack(packId, packName, energyAmount, price) {
        if (confirm(`"${packName}" ni ${price} coin ga sotib olishni xohlaysizmi? Siz +${energyAmount} energiya olasiz.`)) {
            fetch('/buy_energy_pack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pack_id: packId,
                    price: price,
                    energy_amount: energyAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    updateUserStats({ 
                        coins: data.new_coins,
                        energy: data.new_energy 
                    });
                    
                    // Tugmani o'zgartirish
                    const button = document.querySelector(`.buy-energy[data-pack-id="${packId}"]`);
                    if (button) {
                        button.disabled = true;
                        button.textContent = 'Sotib olindi';
                    }
                } else {
                    alert('Xatolik: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Xatolik:', error);
                alert('Server xatosi!');
            });
        }
    }

    // Bajarilgan topshiriqlar sonini yangilash
    function updateCompletedTasksCount() {
        const completedTasks = document.querySelectorAll('.completed-task').length;
        const totalTasks = document.querySelectorAll('.task-card').length;
        const badge = document.getElementById('completed-tasks');
        if (badge) {
            badge.textContent = `Bajarilgan: ${completedTasks}/${totalTasks}`;
        }
    }

    // DOM yuklanganida ishga tushirish
    document.addEventListener('DOMContentLoaded', function() {
        // Topshiriq bajarish tugmalari
        document.querySelectorAll('.complete-task').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.dataset.taskId;
                const taskTitle = this.dataset.taskTitle;
                const energyCost = parseInt(this.dataset.energyCost);
                const rewardCoins = parseInt(this.dataset.rewardCoins);
                
                completeTask(taskId, taskTitle, energyCost, rewardCoins);
            });
        });

        // Mahsulot sotib olish tugmalari
        document.querySelectorAll('.buy-item').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const itemName = this.dataset.itemName;
                const itemPrice = parseInt(this.dataset.itemPrice);
                
                buyItem(itemId, itemName, itemPrice);
            });
        });

        // Energiya paketi sotib olish tugmalari
        document.querySelectorAll('.buy-energy').forEach(button => {
            button.addEventListener('click', function() {
                const packId = this.dataset.packId;
                const packName = this.dataset.packName;
                const energyAmount = parseInt(this.dataset.energy);
                const price = parseInt(this.dataset.price);
                
                buyEnergyPack(packId, packName, energyAmount, price);
            });
        });
    });

    // Sahifani yangilash
    function refreshTasks() {
        location.reload();
    }
</script>
{% endblock %}